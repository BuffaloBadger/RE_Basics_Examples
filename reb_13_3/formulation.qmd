---
format:
  html:
    toc: false
    embed-resources: true
---

```{r}
#| echo: false
#| output: false
library(tidyverse)
library(knitr)
library(kableExtra)
source('~/Libraries/R/fmt_tibble_col.R')
```

### Example 13-3

{{< include problem_statement.qmd >}}

```{r}
#| echo: false
#| output: false
path_to_data <- './Data/'
path_to_results <- './Results/'
path_to_figures <- './Results/'
```

---

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

This assignment describes a single BSTR and no other reactors, heat exchangers, or stream mixing/splitting points. It describes the reactor, its operation, and the reactions taking place, including the rate expressions. It asks me to find a reaction time to maximize yield. From these characteristics, I now that this is an isolated reactor modeling assignment. Ffrom @sec-5_response_opt_design, I also know the general approach for solving this type of assignment.

I like to start assignments by creating a concise summary of the information provided in the assignment.

:::

**Reactor**: BSTR

**Given**: $P_{A,0}=1\text{ atm}$, $P_{B,0}=2\text{ atm}$, $T_0 = 25\text{ °C}$, $V= 2\text{ L}$, $A= 600\text{ cm}^2$, $U= 0.6 \text{ cal cm}^{-2} \text{ min}^{-1}\text{ K}^{-1}$, $T_e =30\text{ °C}$, $k_{0,1} =  3.34 \times 10^9 \text{ mol cm}^{-3}\text{ min}^{-1}\text{ atm}^{-2}$, $k_{0,2} = 4.99 \times 10^9 \text{ mol cm}^{-3}\text{ min}^{-1}\text{ atm}^{-2}$, $E_1= 20.5\text{ kcal mol}^{-1}$, $E_2= 21.8\text{ kcal mol}^{-1}$, $\Delta H_1= -6,300 \text{ cal mol}^{-1}$, $\Delta H_2= -6,900 \text{ cal mol}^{-1}$, $\hat C_{p,A}= 7.4 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,B}= 8.6 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,D}= 10.7 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,Z}= 5.2 \text{ cal mol}^{-1}\text{ K}^{-1}$ and $\hat C_{p,U}= 10.3 \text{ cal mol}^{-1}\text{ K}^{-1}$.

**Quantities of Interest**: $\underset{t_{rxn}}{\arg\max} \left(Y_{D/A}\right)$, $\max \left(Y_{D/A}\right)$, $f_A$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The first step in the general approach to completing isolated reactor modeling assignments is to write the reactor design equations for the reactor. @sec-3_design_eqns described how to do this.

Mole balances are always included in the reactor design equations. The general BSTR mole balance is given in @eq-bstr_mole_balance.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j
$$

I will use this equation to write mole balances for every reagent in the system. That is, I'll write the mole balance for $i$ = A, B, D, Z, and U. There are two reactions taking place, so the sum will expand to two terms in each mole balance.

$$
\frac{dn_i}{dt} = \left( \nu_{i,1}r_1 + \nu_{i,2}r_2 \right)V
$$

This reactor is not isothermal, so I will need to include a BSTR reacting fluid energy balance among the reactor design equations. The BSTR energy balance is given in @eq-bstr_energy_balance

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt} - V\frac{dP}{dt}  - P  \frac{dV}{dt}  = \dot Q - \dot W - V \sum_j \left(r_j \Delta H_j \right)
$$

The reactor has rigid walls and no moving boundaries, so it's volume is constant. If the volume is constant, the time-derivative of the volume is equal to zero. Being a gas phase system with a constant volume, the pressure is expected to change because the temperature will change. Therefore I *cannot* set the time-derivative of the pressure equal to zero. With no moving boundaries, the only work is that of the agitator, which is assumed to be negligible. The summation over $i$ includes every reagent, and as above, the summation over $j$ expands to two terms.

$$
\begin{aligned}
\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} &- V\frac{dP}{dt}  - P  \cancelto{0}{\frac{dV}{dt}}  \\&= \dot Q - \cancelto{0}{\dot W} - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned}
$$

An exchange fluid is present in this reactor, but the assignment states that its temperature is constant at 30 °C. Knowing the exchange fluid temperature, the reactor design equations can be solved independently of an energy balance on the exchange fluid, so I do not need to include an energy balance on the exchange fluid among the reactor design equations.

:::

**Reactor Model**

Mole balances of each of the reagents are presented in equations (5) through (9), and an energy balance on the reacting fluid is presented in equation (10).

$$
\frac{dn_A}{dt} = -r_1V \tag{5}
$$

$$
\frac{dn_B}{dt} = \left( -r_1 - r_2 \right)V \tag{6}
$$

$$
\frac{dn_D}{dt} = \left( r_1 - r_2 \right)V \tag{7}
$$

$$
\frac{dn_Z}{dt} = \left( r_1 + r_2 \right)V \tag{8}
$$

$$
\frac{dn_U}{dt} = r_2V \tag{9}
$$

$$
\begin{aligned}
&\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} - V\frac{dP}{dt} \\&= \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned} \tag{10}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

At this point I have 5 initial value ordinary differential equations (IVODEs) that contain 6 dependent variables (n~A~, n~B~, n~D~, n~Z~, n~U~, T, and P). I either need to eliminate an independent variable or add an IVODE before I can solve the reactor design equations.

Noting that V is constant, I'm going to take the time-derivative of the ideal gas law and use it as an additional IVODE.

$$
PV - \left(n_A + n_B + n_D + n_Z + n_U \right)RT =0
$$

$$
\begin{aligned}
V\frac{dP}{dt} &- RT\left(\frac{dn_A}{dt} + \frac{n_B}{dt} + \frac{n_D}{dt} + \frac{n_Z}{dt} + \frac{n_U}{dt} \right) \\&- R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}
$$

:::

Taking the derivative of the ideal gas law yields equation (11).

$$
\begin{aligned}
V\frac{dP}{dt} &- RT\left(\frac{dn_A}{dt} + \frac{n_B}{dt} + \frac{n_D}{dt} + \frac{n_Z}{dt} + \frac{n_U}{dt} \right) \\&- R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}\tag{11}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I now have 6 IVODEs with 6 dependent variables. Initial values and a stopping criterion are needed in order to solve these equations. I can define $t=0$ to be instant that the A and B are added to the reactor, and let $n_{A,0}$, $n_{B,0}$, $P_0$, and $T_0$ represent the molar amounts of A and B, the pressure, and the temperature at that instant. Initially the reactor does not contain D, Z, or U, so the initial molar amounts of those reagents is equal to zero. The stopping criterion is $t=t_rxn$.

:::

The initial values and stopping criterion for equations (5) through (11) are presented in @tbl-example_13_3_initial_values.

| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $0$ | $t_{rxn}$ |
| $n_A$ | $n_{A,0}$ | |
| $n_B$ | $n_{B,0}$ | |
| $n_D$ | $0$ | |
| $n_Z$ | $0$ | |
| $n_U$ | $0$ | |
| $T$ | $T_0$ | |
| $P$ | $P_0$ | |
  
: Initial values and stopping criterion for solving the design equations, (5) through (11). {#tbl-example_13_3_initial_values tbl-colwidths="[20, 40, 40]"}

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The reactor design equations, (5) through (11), are a set of IVODEs. The next step in the general approach to completing isolated reactor modeling assignments is to formulate their solution. In order to solve them, I must have numerical values for the initial values and stopping criterion, and I need to express every quantity that appears in the IVODEs or that is substituted into them in terms of known constants, the independent variable, $t$, and the dependent variables, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $T$, and $P$.

Looking at the quantities in the IVODEs, $V$, $\hat C_{p,A}$, $\hat C_{p,B}$, $\hat C_{p,D}$, $\hat C_{p,Z}$, $\hat C_{p,U}$, $\Delta H_1$, $\Delta H_2$, and the gas constant, $R$, are known constants. The reaction rates are given by equations (3) and (4). Substituting the rate expressions into the reactor design equations introduces the known constants, $k_{0,1}$, $k_{0,2}$, $E_1$, and $E_2$, along with the partial pressures of A, B, and D. The partial pressures can be calculated using the ideal gas law.

$$
P_i = \frac{n_iRT}{V}
$$

The rate of heat transfer, $\dot{Q}$, can be expressed in terms of $T$ and the known, constant heat transfer coefficient, $U$, heat transfer area, $A$, and exchange fluid temperature, $T_{ex}$, @eq-bstr_heat_transfer.

The initial molar amounts of A and B can be calculated using the ideal gas law and the initial pressure is simply the sum of the initial partial pressures of A and B.

:::

**Ancillary Equations**

The partial pressures in the rate expression can be calculated using equations (12) through (14). The rate of heat transfer can be calculated using equation (15). The initial molar amounts of A and B can be calculated using equations (16) and (17), and the initial total pressure can be calculated using equation (18).

$$
P_A = \frac{n_ART}{V} \tag{12}
$$

$$
P_B = \frac{n_BRT}{V} \tag{13}
$$

$$
P_D = \frac{n_DRT}{V} \tag{14}
$$

$$
\dot Q = UA\left( T_{ex} - T \right) \tag{15}
$$

$$
n_{A,0} = \frac{P_{A,0}V}{RT} \tag{16}
$$

$$
n_{B,0} = \frac{P_{B,0}V}{RT} \tag{17}
$$

$$
P_0 = P_{A,0} + P_{B,0} \tag{18}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The assignment does not provide a numerical value for $t_{rxn}$ to use as the stopping criterion, so it is either a missing value or an adjusted value. In this assignment, I am asked to find the value of $t_{rxn}$ that maximizes the yield. To do that, I will select a range of values for $t_{rxn}$, calculate the yield for each one, and plot the results. Then I'll identify the maximum from the graph. Thus, for this assignment, $t_{rxn}$ is an adjusted value.

:::

**Adjusted Value**: $t_{rxn}$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The third step in the general approach for completing isolated reactor modeling assignments is to use the results from solving the reactor design equations to calculate the responses of interest. The response function will be passed values for the reaction time. Given those values, the reactor design equations can be solved numerically to find the final values of the dependent variables, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $T$, and $P$. Those results must then be used to calculate the responses to be returned by the response function. In this assignment the responses of interest are the yield and the conversion of A. Both of these can be calculated using their definitions, @eq-yield_def_closed and @eq-conversion_def_closed.

:::

**Response Calculation**

After solving the reactor design equations, the yield and conversion can be calculated using equations (19) and (20).

$$
Y_{D/A} = \frac{n_D}{n_{A,0}} \tag{19}
$$

$$
f_A=\frac{n_{A,0}-n_A}{n_{A,0}} \tag{20}
$$

**Response Function**

The response function is created with the following structure:

* It is passed a set of values of $t_{rxn}$ as an argument.
* Variables are defined and assigned the values of all known and given quantities: $P_{A,0}=1\text{ atm}$, $P_{B,0}=2\text{ atm}$, $T_0 = 25\text{ °C}$, $V= 2\text{ L}$, $A= 600\text{ cm}^2$, $U= 0.6 \text{ cal cm}^{-2} \text{ min}^{-1}\text{ K}^{-1}$, $T_e =30\text{ °C}$, $k_{0,1} =  3.34 \times 10^9 \text{ mol cm}^{-3}\text{ min}^{-1}\text{ atm}^{-2}$, $k_{0,2} = 4.99 \times 10^9 \text{ mol cm}^{-3}\text{ min}^{-1}\text{ atm}^{-2}$, $E_1= 20.5\text{ kcal mol}^{-1}$, $E_2= 21.8\text{ kcal mol}^{-1}$, $\Delta H_1= -6,300 \text{ cal mol}^{-1}$, $\Delta H_2= -6,900 \text{ cal mol}^{-1}$, $\hat C_{p,A}= 7.4 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,B}= 8.6 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,D}= 10.7 \text{ cal mol}^{-1}\text{ K}^{-1}$, $\hat C_{p,Z}= 5.2 \text{ cal mol}^{-1}\text{ K}^{-1}$ and $\hat C_{p,U}= 10.3 \text{ cal mol}^{-1}\text{ K}^{-1}$.
* A function that evaluates the derivatives in the design equations given values of the independent variable, $t$, and the dependent variables, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $T$, and $P$ is defined. It
	* Calculates $P_A$, $P_B$, and $P_D$ using equations (12), (13), and (14).
	* Calculates $r_1$ and $r_2$ using equations (3) and (4).
	* Calculates $\dot{Q}$ using equation (15).
	* Evaluates and returns the values of the derivatives, equations (5) through (11).
* For each value of $t_{rxn}$ that is passed to the response function, it then
	* Calculates $n_{A,0}$, $n_{B,0}$, and $P_0$ using equations (16), (17) and (18).
	* Solves the design equations using the initial values and stopping criterion in @tbl-example_13_3_initial_values to find $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $T$, and $P$ at $t=t_{rxn}$.
	* Calculates and saves $Y_{D/A}$, and $f_A$ using equations (19) and (20).
* Returns the sets of values of $Y_{D/A}$, and $f_A$ corresponding to the values of $t_{rxn}$ passed to it.

**Calculations**

1. The response function is called, passing to it a vector containing a range of values of $t_{rxn}$. (Note the range of values may need to be adjusted).
2. The response function returns vectors containing the corresponding values of $Y_{D/A}$, and $f_A$.
3. The values of $Y_{D/A}$ are plotted against $t_{rxn}$.
4. The graph resulting from step 3 is inspected.
	a. If it shows a maximum, the value of $t_{rxn}$ corresponding to the maximum value of $Y_{D/A}$ and the maximum value of $Y_{D/A}$ are two of the quantities of interest. The conversion of A at the value of $t_{rxn}$ corresponding to the maximum value of $Y_{D/A}$ is the other quantity of interest.
	b. If it does not show a maximum, the range of values of $t_{rxn}$ is adjusted and steps 2 through 4 are repeated.

**Results**

```{r}
#| echo: false
#| output: false
df <- read.csv(paste0(path_to_results,'reb_13_3_results.csv'))
```

The calculations were performed as described above. The resulting plot of yield *vs*. reaction time is shown in @fig-example_13_3_yield_plot. The maximum yield, `r df$value[2]``r df$units[2]`, occurs at a reaction time of `r df$value[1]` `r df$units[1]`. The conversion of A at that reaction time is `r df$value[3]``r df$units[3]`.

![Yield of D as the reaction time varies.](`r paste0(path_to_figures,'reb_13_3_yield_plot.png')`){#fig-example_13_3_yield_plot width="80%"}

**Summary and Comments**

Reactions (1) and (2) constitute a series-parallel reaction network. The desired product, D, is an intermediate product. It is produced in reaction (1) and consumed in reaction (2). Assuming that the temperature affects the two reactions equally, the yield of an intermediate product is expected to pass through a maximum as the reaction time increases as seen in @fig-example_13_3_yield_plot.

The reason for the maximum is qualitatively easy to understand. At the start of the reaction, the rate of reaction (1) will be positive while that for reaction (2) will be zero. Thus, initially the amount of D will increase as can be seen in @fig-example_13_3_yield_plot. After a very small interval of time, the rate of reaction (1) will decreasing due to the decreasing concentration of reactant A while the rate of reaction (2) will be increasing due to the increasing concentration of reactant D. For as long as the rate of reaction (2) remains smaller than the rate of reaction (1), the amount of D will be increasing, but at a smaller and smaller rate. This can be seen in @fig-example_13_3_yield_plot where the curvature of the yield plot is initially concave downward,

Eventually, the rate of reaction (2) will become equal to the rate of reaction (1). For that instant in time, the amount of D will not be changing. This corresponds to the maximum in @fig-example_13_3_yield_plot. At times beyond the maximum the rate of reaction (1) is less than the rate of reaction (2), so the concentration of D decreases. As the concentrations of both reactants, A and D, continue to decrease, both reactions (1) and (2) become slower and slower. This can be seen at larger reaction times in @fig-example_13_3_yield_plot where the curve is concave upward. Eventually, at very large reaction time, the rates will equal zero.

[add note about reaction time being a primary parameter for adjusting the amount of an intermediate product in a series reaction network, noting that other parameters will also affect it.]