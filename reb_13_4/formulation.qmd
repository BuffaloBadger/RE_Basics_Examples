---
format:
  html:
    toc: false
    embed-resources: true
---

```{r}
#| echo: false
#| output: false
library(tidyverse)
library(knitr)
library(kableExtra)
source('~/Libraries/R/fmt_tibble_col.R')
```

### Example 13-4

{{< include problem_statement.qmd >}}

```{r}
#| echo: false
#| output: false
path_to_data <- './Data/'
path_to_results <- './Results/'
path_to_figures <- './Results/'
```

---

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Using the criteria presented in @sec-5_response_opt_design, this is an isolated reactor modeling assignment. The system consists of a BSTR and no other equipment. The reactor and its operation are described. The reaction taking place is indentified and its rate expression is provided, and it asks for a reactor input, namely the coolant flow rate. Additionally, this is an optimization assignment because the coolant flow rate of interest is the one that maximizes the net rate of production of Z.

Having identified this as an isolated reactor optimization assignment, I know the general approach to take to complete it, again from @sec-5_response_opt_design. I will need to select the reactor design equations needed to model the system, formulate their solution (assuming missing reactor inputs and process parameters will be provided), formulate the calculation of the response of interest (here the net rate of production of Z), create a response function that incorporates those formulations, and use the response function to calculate the quantities of interest. Being an optimization assignment, I'll do that by selecting a range of values of the coolant flow rate, calculate the net rate for each of them, plot the results, and identify the maximum net rate using the graph.

To get started, I'll summarize the information provided in the assignment. I'll use a subscripted "ex" to denote quantities related to the jacket and "coil" to denote quantities related to the coil. I'll use a subscripted "0" to denote initial values of quantities, a subscripted "1" to denote quantities at the time the temperature reaches 50 °C, and a subscripted "f" to denote quantities at the end of the processing steps.

:::

**Reactor**:  BSTR

**Given**: $k_{0,1}$ = 2.59 x 10^9^ min^-1^, $E_1$ = 16.5 kcal mol^-1^, $\Delta H_1$ = -22,200 cal mol^-1^, $C_{A,0}$ = 2 M, $T_0$ = 23 °C, $\breve{C}_p$ = 440 cal L^-1^ K^-1^, $V$ = 4.0 L, $V_{ex}$ = 0.5 L, $A_{ex}$ = 0.6 ft^2^, $U_{ex}$ = 1.13 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $T_{ex,in}$ = 20 °C, $\rho_{ex}$ = 1 g cm^-3^, $\tilde{C}_{p,ex}$ = 1 cal g^-1^ K^-1^, $U_{coil}$ = 3.8 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $A_{coil}$ =  0.23 ft^2^, $T_{coil}$ = 120 °C, $T_{ex,0}$ = 23 °C, $\dot{m}_{ex,0}$ = 0, $T_1$ = 50 °C, $T_f$ = 25 °C, $t_{turn}$ = 25 min.

**Quantities of Interest**: $\dot{m}_{ex,opt} = \underset{\dot{m}_{ex}}{\arg\max} \left(r_{Z,net}\right)$, $\underset{\dot{m}_{ex}}{\max} \left(r_{Z,net}\right)$, $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$, $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I need to write the reactor design equations needed to model this system. The reactor design equations always include at least one mole balance. The general BSTR mole balance is given in @eq-bstr_mole_balance.  I'll write a mole balance for both of the reagents in this system, noting that the sum reduces to a single term since only one reaction is taking place.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j
$$

The BSTR is not isothermal, so I must include an energy balance on the reacting fluid among the design equations. The general BSTR mole balance is given in @eq-bstr_energy_balance. Assuming the liquid to be incompressible and the reactor walls to be rigid, both the pressure and volume will be constant, so their time-derivatives will equal zero. The work associated with mixing the reactor can also be assumed to be negligible.

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt} - V\cancelto{0}{\frac{dP}{dt}}  - P  \cancelto{0}{\frac{dV}{dt}}  = \dot Q - \cancelto{0}{\dot W} - V \sum_j \left(r_j \Delta H_j \right)
$$

There is only one reaction occurring, so the final sum will reduce to a single term. In addition, the assignment provides the volumetric heat capacity of the entire solution, so the sensible heat term can be written in terms of that heat capacity, @eq-bstr_equivalent_sens_heat_terms. Heat is exchanged with both the cooling water and the steam, so the rate of heat exchange must be split into two terms

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt}\ \Leftrightarrow\  V \breve C_p \frac{dT}{dt}
$$

$$
\dot{Q} = \dot{Q}_{ex} + \dot{Q}_{coil}
$$

There are two heat exchange fluids in this system. The water in the jacket exchanges sensible heat so the energy balance on it is given by @eq-exchange_energy_bal_sensible. Noting that the heat capacity is constant, the integral is easily evaluated.

$$
\rho_{ex} V_{ex} \tilde C_{p,ex}\frac{dT_{ex}}{dt} = -\dot{Q}_{ex} - \dot m_{ex} \int_{T_{ex,in}}^{T_{ex}} \tilde C_{p,ex}dT
$$

The steam in the coil exchanges latent heat, so the its temperature is known and constant. As a consequence, the mole balances, energy balance on the reacting fluid and energy balance on the cooling water can be solved independently of the energy balance on the steam. The problem does not ask any questions about the steam flow rate or how much of it condenses, so an energy balance on the steam is not needed.

Momentum balances are not used for stirred tank reactors, so the full set of reactor design equations consists of mole balances on A and Z, an energy balance on the reacting fluid and an energy balance on the cooling water.

:::

**Reactor Model**

Mole balances on A and Z are presented in equations (3) and (4). An energy balance on the reacting fluid is given in equation (5), and an energy balance on the cooling water in equation (6).

$$
\frac{dn_A}{dt} = -Vr_1 \tag{3}
$$

$$
\frac{dn_Z}{dt} = Vr_1 \tag{4}
$$

$$
V \breve C_p \frac{dT}{dt}  = \dot{Q}_{ex} + \dot{Q}_{coil}  - Vr_1 \Delta H_1 \qquad \Rightarrow \qquad \frac{dT}{dt} = \frac{\dot{Q}_{ex} + \dot{Q}_{coil}  - Vr_1 \Delta H_1}{V \breve C_p} \tag{5}
$$

$$
\rho_{ex} V_{ex} \tilde C_{p,ex}\frac{dT_{ex}}{dt} = -\dot{Q}_{ex} - \dot m_{ex} \tilde{C}_{p,ex} \left(T_{ex} - T_{ex,in}\right)
$$

$$
\frac{dT_{ex}}{dt} = -\left(\frac{\dot{Q}_{ex} + \dot m_{ex} \tilde{C}_{p,ex} \left(T_{ex} - T_{ex,in}\right)}{\rho_{ex} V_{ex} \tilde C_{p,ex}}\right) \tag{6}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The reactor design equations, (3) through (6), are initial value ordinary differential equations (IVODEs), so initial values and a stopping criterion are needed. I could analyze the entire process all at once, but here I'm going to analyze it as two phases: the heating phase and the cooling phase.

The instant the solution is added to the reactor can be defined as $t=0$. This marks the start of the heating phase. The molar amounts of A, $n_{A,0}$, and Z, 0.0 (only A is present initially), the reacting fluid temperature, $T_0$, and the cooling water temperature, $T_{ex,0}$, at that time are then the initial values for the analysis of the heating phase. It ends when the reacting fluid reaches $T_1 = 50 °C$.

The cooling phase begins the instant the heating phase ends, so the initial values for the cooling phase are the final values from the heating phase. The cooling phase ends when the reacting fluid cools down to $T_f = 25 °C$, so that is the stopping criterion for the cooling phase.

:::

The initial values and stopping criterion for solving the reactor design equations for the heating phase are presented in @tbl-example_13_4_heating_initial_values. If $t_1$, $n_{A,1}$, $n_{Z,1}$, and $T_{ex,1}$ represent the values of $t$, $n_A$, $n_Z$, and $T_{ex}$ at the end of the heating phase, those values are also the intial values for the cooling phase, which ends when $T = T_f$. Thus, the initial values and stopping criterion for the coolling phase are given in @tbl-example_13_4_cooling_initial_values

| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $0$ | |
| $n_A$ | $n_{A,0}$ | |
| $n_Z$ | 0 | |
| $T$ | $T_0$ | $T_1$ |
| $T_{ex}$ | $T_{ex,0}$ | |
  
: Initial values and stopping criterion for solving the design equations, (3) through (6), for the heating phase of the process. {#tbl-example_13_4_heating_initial_values tbl-colwidths="[20, 40, 40]"}


| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $t_1$ | |
| $n_A$ | $n_{A,1}$ | |
| $n_Z$ | $n_{Z,1}$ | |
| $T$ | $T_1$ | $T_f$ |
| $T_{ex}$ | $T_{ex,1}$ | |
  
: Initial values and stopping criterion for solving the design equations, (3) through (6), for the cooling phase of the process. {#tbl-example_13_4_cooling_initial_values tbl-colwidths="[20, 40, 40]"}

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

In order to solve the reactor design equations, every quantity appearing in them or substituted into them must be expressed in terms of known constants, the independent variable, $t$, and the dependent variables, $n_A$, $n_Z$, $T$, and $T_{ex}$. The initial values and stopping criterion must also be calculated.

Looking at the reactor design equations, I see that $V$, $\breve{C}_p$, $\Delta H_1$, $\rho_{ex}$, $\tilde{C}_{p,ex}$, and $T_ex,in$ are known constants. The water flow rate, $\dot{m}_{ex}$, will equal 0 until the reacting fluid temperature reaches 50 °C. After that, $\dot{m}_{ex}$ will be constant with a value that will be provided at the time the reactor design equations are solved.

The reaction rate, $r_1$, is given by equation (2); it introduces $k_1$ and $C_A$ when it is substituted into the design equations. The rate coefficient can be expressed in terms of known constants ($k_{0,1}$, $E_1$, and the gas constant, $R$) using the Arrhenius expression, @eq-arrhenius. The concentration of A can be expressed in terms of the molar amount of A and the volume using the definition of concentration.

The rate of heat exchange between the water in the jacket and the reacting fluid can be expressed in terms of the known constants, $A_{ex}$ and $U_{ex}$, and the jacket and reacting fluid temperatures. Similarly, the rate of heat exchange between the steam in the coil and the reacting fluid can be expressed in terms of the kknown constants, $U_{coil}$, $A_{coil}$, and $T_{coil}$ = 120 °C, and the reacting fluid temperature. However, the coil only exchanges heat until the reacting fluid reaches 50 °C.

The initial moles of A can be calculated from the known initial concentration of A and the volume.

:::

**Ancillary Equations**

The water flow rate is given by equation (7), and the rate of heat exchange with the steam by equation (8). Both of these terms change when the heating phase ends and the cooling phase begins. The rate of heat exchange between the water in the jacket and the reacting fluid is given by equation (9).

$$
\dot{m}_{ex} \big\vert_{t \lt t_1} = 0 \qquad \qquad \dot{m}_{ex} \big\vert_{t \ge t_1} = \dot{m}_{ex} \tag{7}
$$

$$
\dot{Q}_{coil}\big\vert_{t \lt t_1} = U_{coil} A_{coil} \left(T_{coil} - T\right) \qquad \qquad \dot{Q}_{coil}\big\vert_{t \ge t_1} = 0 \tag{8}
$$

$$
\dot{Q}_{ex} = U_{ex} A_{ex} \left(T_{ex} - T\right) \tag{9}
$$

The rate is given by equation (2), where the rate coefficient is found using equation (10) and the concentration of A is found using equation (11). The initial molar amount of A can be calculated using equation (12).

$$
k_1 = k_{0,1}\exp{\left( \frac{-E_1}{RT} \right)} \tag{10}
$$

$$
C_A = \frac{n_A}{V} \tag{11}
$$

$$
n_{A,0} = C_{A,0}V \tag{12}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

At this point, the only thing needed in order to solve the design equations is the value of the cooling water flow rate, $\dot{m}_{ex}$. Assuming that value will be provided when needed, the design equations can be solved to find $n_A$, $n_Z$, $T$, and $T_{ex}$ at times between $t=0$ and the time, $t_f$, when the reactor cools to 25 °C. The conversion as a function of processing time can be calculated using its definition, @eq-conversion_def_closed. The final time and the final molar amount of A can then be used to calculate the net rate of production of Z, using @eq-bstr_net_rate.

:::

**Adjusted Value**: $\dot{m}_{ex}$

**Response Calculation**

Solving the reactor design equations will yield $n_A\left(t\right)$ and $T\left(t\right)$ directly. The conversion as a function of reaction time can then be calculated using equation (13). The final reaction time, $t_f$, and the final molar amount of Z, $n_Z$, can be used to calculate the net rate of production of Z using equation (14).

$$
f_A\left(t\right) = \frac{n_{A,0} - n_A\left(t\right)}{n_{A,0}} \tag{13}
$$

$$
r_{Z,net} = \frac{n_Z}{t_f + t_{turn}} \tag{14}
$$

**Response Function**

The response function is created with the following structure:

* The adjusted value, that is the coolant flow rate, $\dot{m}_{ex}$, is passed to the response function as an argument.
* Variables are defined and assigned the values of all known and given quantities: $k_{0,1}$ = 2.59 x 10^9^ min^-1^, $E_1$ = 16.5 kcal mol^-1^, $\Delta H_1$ = -22,200 cal mol^-1^, $C_{A,0}$ = 2 M, $T_0$ = 23 °C, $\breve{C}_p$ = 440 cal L^-1^ K^-1^, $V$ = 4.0 L, $V_{ex}$ = 0.5 L, $A_{ex}$ = 0.6 ft^2^, $U_{ex}$ = 1.13 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $T_{ex,in}$ = 20 °C, $\rho_{ex}$ = 1 g cm^-3^, $\tilde{C}_{p,ex}$ = 1 cal g^-1^ K^-1^, $U_{coil}$ = 3.8 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $A_{coil}$ =  0.23 ft^2^, $T_{coil}$ = 120 °C, $T_{ex,0}$ = 23 °C, $\dot{m}_{ex,0}$ = 0, $T_1$ = 50 °C, $T_f$ = 25 °C, $t_{turn}$ = 25 min.
* A function that evaluates the derivatives in the design equations given values of the independent variable, $t$, and the dependent variables, $n_A$, $n_Z$, $T$, and $T_{ex}$, is defined. It
	* Sets the value of $\dot{m}_{ex}$ according to equation (7).
	* Calculates $\dot{Q}_{coil}$, $\dot{Q}_{ex}$, $k_1$, and $C_A$ using equations (8) through (11).
	* Calculates $r_1$ using equation (2).
	* Evaluates and returns the values of the derivatives, equations (3) through (6).
* The response function then
	* Calculates $n_{A,0}$ using equation (12).
	* Solves the design equations for the heating phase using the initial values and stopping criterion in @tbl-example_13_4_heating_initial_values to find the final values of $t_1$, $n_{A,1}$, $n_{Z,1}$, and $T_{ex,1}$.
	* Solves the design equations for the cooling phase using the initial values and stopping criterion in@tbl-example_13_4_cooling_initial_values to find the values of $t$, $n_A$, $n_Z$, $T$, and $T_{ex}$ at the end of the processing.
	* Calculates the conversion as a function of reaction time using equation (13) and the net rate of production of Z using equation (14).
	* Returns the net rate of production of Z and vectors containing the reaction time, conversion and reacting fluid temperature.

**Calculations**

1. A range of values of $\dot{m}_{ex}$ is chosen. (Note the range of values may need to be adjusted.)
2. The response function is used to calculate $r_{Z,net}$ for each value of $\dot{m}_{ex}$.
3. The resulting values of $r_{Z,net}$ are plotted against $\dot{m}_{ex}$.
4. The graph produced in step 3 is inspected.
	a. If it shows a maximum, the value of $\dot{m}_{ex}$ corresponding to the maximum value of $r_{Z,net}$ and the maximum value of $r_{Z,net}$ are the quantities of interest.
	b. If it does not show a maximum, the range of values of $\dot{m}_{ex}$ is adjusted and steps 2 through 4 are repeated.
5. The response function is used to calculate $t$, $f_A\left(t\right)$, and $T\left(t\right)$ using the optimum coolant rate found in step 4.
6. The conversion and reacting fluid temperature are plotted *vs*. the reaction time.

:::{.callout-note collapse="false"}
## Note

Once a maximum has been found graphically, the process can be repeated using a large number of values of $\dot{m}_{ex}$ packed into a small range that includes the maximum. This will improve the accuracy of the results. These results need not be plotted. Instead they can be tabulated. The largest value of $r_{Z,net}$ can then be identified, and the corresponding value of $\dot{m}_{ex}$ can be read from the same row of the table.

:::

**Results**

```{r}
#| echo: false
#| output: false
df <- read.csv(paste0(path_to_results,'reb_13_4_results.csv'))
```

The calculations were performed as described above. The net rate of production of Z is plotted as a function of the cooling water flow rate in @fig-example_13_4_net_rate_plot. The maximum net rate, `r df$value[1]` `r df$units[1]`, occurs at a coolant flow rate of `r df$value[2]` `r df$units[2]`. The conversion and reacting fluid temperature profiles at that coolant flow rate are shown in @fig-example_13_4_conversion_profile and @fig-example_13_4_temperature_profile. Knowing the initial concentration of A and the Arrhenius parameters, the conversion and temperature profiles were used to calculate the reaction rate profile shown in @fig-example_13_4_rate_profile, where the rate scale is logarithmic.

![Net rate of production of Z as cooling water flow rate varies.](`r paste0(path_to_figures,'reb_13_4_net_rate_plot.png')`){#fig-example_13_4_net_rate_plot width="80%"}

![Conversion profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_conversion_profile.png')`){#fig-example_13_4_conversion_profile width="80%"}

![Temperature profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_temperature_profile.png')`){#fig-example_13_4_temperature_profile width="80%"}

![Instantaneous reaction rate profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_rate_profile.png')`){#fig-example_13_4_rate_profile width="80%"}

**Summary and Comments**

At the initial conditions, the instantaneous rate of reaction is extremely small as can be seen in @fig-example_13_4_rate_profile, and consequently conversion of A initially increases very slowly, @fig-example_13_4_conversion_profile. For this reason, the steam heating coil is used to heat the reacting fluid to 50 °C. This requires ca. 3.5 min and can be seen in @fig-example_13_4_temperature_profile and @fig-example_13_4_net_rate_plot as an abrupt decrease in the slope at that time.

Once the steam heating coil is removed, heat is being generated due to the heat of reaction and simulataneously heat is being removed by transfer to the cooling water in the jacket. The rate of heat generation must be greater than the rate of heat removal, because @fig-example_13_4_temperature_profile shows that the temperature continues to rise.

As the reaction proceeds, the temperature is increasing while the concentration of reactant A is decreasing due to consumption by reaction. The increasing temperature alone would cause the rate to increase while the decrease in reactant concentration, alone, would cause the rate to decrease. As is very often the case, the effect of increasing temperature is stronger than the effect of decreasing concentration, so the rate increases. This, in turn, causes the temperature to rise even faster, as can be seen in the temperature profile just after the end of the heating phase where the profile is concave downward.

Eventually the effects of increasing temperature and decreasing concentration become equal. This corresponds to the maximum in the instantaneous reaction rate profile, @fig-example_13_4_rate_profile, at ca `r df$value[4]` `r df$units[4]`. At this point, the temperature profile, @fig-example_13_4_temperature_profile, displays an inflection point. For a brief period after the rate reaches its maximum, the temperature continues to rise, reaching a maximum value of `r df$value[5]` `r df$units[5]` at ca. `r df$value[6]` `r df$units[6]`. This happens because while the rate is starting to decrease, the reaction is still generating heat faster than the cooling water is removing it.

Once the temperature passes through its maximum, heat is being removed by transfer to the cooling water in the jacket faster than it is being generated by reaction. As a result the temperature and rate decrease steadily. Nonetheless, the conversion had already reached `r df$value[7]``r df$units[7]` when the temperature started to decrease and ultimately increased to `r df$value[8]``r df$units[8]` by the time the reacting fluid cooled to 25 °C.

:::{.callout-note collapse="false"}
## Note

In this example, the net rate of reaction was maximized with respect to the cooling water flow rate. It might be possible to improve the process further by adjusting both the cooling water flow rate *and* the temperature where the heating coil is removed. If that were done, the graphical approach used here to maximize the net rate would not be the best mathematical approach. Instead, a reaction engineer might instead use software designed for multivariable optimization.

:::
